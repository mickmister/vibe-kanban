# syntax=docker/dockerfile:1

FROM node:20-slim

# Install system dependencies, Rust, and pnpm in one optimized layer
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    rm -f /etc/apt/apt.conf.d/docker-clean && \
    echo 'Acquire::Retries "3";' > /etc/apt/apt.conf.d/80-retries && \
    echo 'Acquire::http::Timeout "10";' >> /etc/apt/apt.conf.d/80-retries && \
    echo 'Acquire::https::Timeout "10";' >> /etc/apt/apt.conf.d/80-retries && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get update -o Acquire::Check-Valid-Until=false && \
    apt-get install -y --no-install-recommends --allow-unauthenticated \
        ca-certificates \
        curl \
        build-essential \
        pkg-config \
        libssl-dev \
        sqlite3 \
        libsqlite3-dev \
        git && \
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain nightly-2025-05-18 && \
    curl -fsSL https://get.pnpm.io/install.sh | sh - && \
    rm -rf /var/lib/apt/lists/*

ENV PATH="/root/.cargo/bin:/root/.local/share/pnpm:${PATH}"
ENV PNPM_HOME="/root/.local/share/pnpm"

WORKDIR /app

# Copy dependency manifests and install with cache mounts
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY frontend/package.json frontend/
COPY npx-cli/package.json npx-cli/
COPY Cargo.toml Cargo.lock ./
COPY crates/*/Cargo.toml crates/

RUN --mount=type=cache,target=/root/.local/share/pnpm/store,sharing=locked \
    --mount=type=cache,target=/root/.cargo/registry,sharing=locked \
    --mount=type=cache,target=/root/.cargo/git,sharing=locked \
    pnpm install --frozen-lockfile

# Copy the rest of the source code
COPY . .

# Expose ports for frontend and backend
EXPOSE 3000 8080

# Start dev server
CMD ["pnpm", "run", "dev"]

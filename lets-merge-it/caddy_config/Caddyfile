:3001 {
	# Route to VSCode Server if URL has "folder" query parameter
	@vscode_query {
		query folder=*
	}

	# Route to VSCode Server for stable-* paths (VSCode assets)
	@vscode_stable {
		path /stable-*
	}

	# Route to VSCode Server for vscode-remote-resource paths
	@vscode_remote {
		path /vscode-remote-resource*
	}

	# VSCode Server - proxy to code-server service (query param routing)
	handle @vscode_query {
		reverse_proxy code-server:8443 {
			header_up Host {upstream_hostport}
			# Handle WebSocket connections
			header_up Upgrade {http.request.header.Upgrade}
			header_up Connection {http.request.header.Connection}
		}
	}

	# VSCode Server - proxy to code-server service (stable-* asset routing)
	handle @vscode_stable {
		reverse_proxy code-server:8443 {
			header_up Host {upstream_hostport}
		}
	}

	# VSCode Server - proxy to code-server service (vscode-remote-resource routing)
	handle @vscode_remote {
		reverse_proxy code-server:8443 {
			header_up Host {upstream_hostport}
		}
	}

	# Main application - proxy to vibe-kanban service (fallback)
	handle /* {
		reverse_proxy vibe-kanban:3000 {
			# Handle WebSocket connections for hot reload, etc.
			header_up Upgrade {http.request.header.Upgrade}
			header_up Connection {http.request.header.Connection}
		}
	}

	# Enable logging for debugging
	log {
		output stdout
		format console
		level INFO
	}
}
